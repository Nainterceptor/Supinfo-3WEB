<!Doctype html>
<html manifest="manifest.appcache">
<head>
    <script src="jquery-2.1.1.min.js"></script>
    <script type="text/javascript">
        jQuery(function () {
            var makeListWithMessages = function (messages) {
                var list = "";
                messages.forEach(function (message) {
                    list += "<li>" + message + "</li>";
                });

                jQuery("#messages").html(list);
            };

            var getMessagesFromStorage = function () {
                if (localStorage.messages == null) {
                    return [];
                } else {
                    return JSON.parse(localStorage.messages);
                }
            };

            var saveMessagesToStorage = function (messages) {
                localStorage.messages = JSON.stringify(messages);
            };

            var pushMessageToStorage = function (message) {
                var messages = getMessagesFromStorage();
                messages.push(message);
                saveMessagesToStorage(messages);
            };

            jQuery.getJSON("messages", function (data) {
                saveMessagesToStorage(data);

                makeListWithMessages(data);
            }).error(function () {
                var messages = getMessagesFromStorage();
                makeListWithMessages(messages);
            });

            var source = new EventSource('/stream');
            source.addEventListener('message', function (event) {
                var element = jQuery('<li>' + event.data + '</li>');
                jQuery("#messages").append(element);

                pushMessageToStorage(event.data);
            });

            jQuery("#messageForm").on('submit', function (event) {
                event.preventDefault();

                var message = JSON.stringify({
                    message: jQuery("#message").val()
                });

                jQuery.ajax({
                    url: 'message',
                    type: 'POST',
                    data: message,
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'json',
                    success: function () {
                        pushMessageToStorage(message);
                    }
                });

            });

        });
    </script>
</head>
<body>
<ul id="messages">

</ul>

<form id="messageForm">
    <label for="message">Message : </label>
    <input type="text" id="message"/>
    <input type="submit"/>
</form>
</body>
</html>